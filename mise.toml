[tools]
node = "22"
rust = "1.85"

[env]
_.path = ['./ui/node_modules/.bin']

# ============================================================================
# SETUP TASKS
# ============================================================================

[tasks.install]
description = "Install frontend dependencies"
dir = "ui"
run = "npm install"
sources = ['package.json', 'package-lock.json']
outputs = ['node_modules']

[tasks.install-tauri-cli]
description = "Install Tauri CLI"
run = "cargo install tauri-cli --version '^2.0'"

[tasks.setup]
description = "Complete development setup"
depends = ["install", "install-tauri-cli"]

# ============================================================================
# DEVELOPMENT TASKS
# ============================================================================

[tasks.dev]
description = "Start development mode (frontend + Tauri)"
depends = ["install"]
run = "cargo tauri dev"

[tasks.dev-frontend]
description = "Start frontend dev server only"
dir = "ui"
run = "npm run dev"

# ============================================================================
# BUILD TASKS
# ============================================================================

[tasks.build-frontend]
description = "Build frontend for production"
depends = ["install"]
dir = "ui"
run = "npm run build"
sources = ['src/**/*', 'index.html', 'vite.config.ts']
outputs = ['../dist']

[tasks.build]
description = "Build complete application"
depends = ["build-frontend"]
run = "cargo tauri build"

[tasks.build-debug]
description = "Build debug version (faster)"
depends = ["build-frontend"]
run = "cargo tauri build --debug"

# ============================================================================
# UTILITY TASKS
# ============================================================================

[tasks.clean]
description = "Clean all build artifacts"
run = '''
#!/usr/bin/env bash
echo "Cleaning build artifacts..."
rm -rf dist 2>/dev/null || true
rm -rf ui/node_modules 2>/dev/null || true
rm -rf src-tauri/target 2>/dev/null || true
echo "Clean completed!"
'''

[tasks.launch-mac]
description = "Run the existing app"
run = "open ./src-tauri/target/debug/bundle/macos/Mocha.app"

[tasks.icons]
description = "Generate app icons from source PNGs in _tmp/icon/"
run = '''
#!/usr/bin/env bash
set -e
SRC=_tmp/icon
DEST=src-tauri/icons

mkdir -p $DEST

# Copy base PNGs for Tauri
cp $SRC/32x32.png $DEST/
cp $SRC/128x128.png $DEST/
cp $SRC/256x256.png $DEST/icon.png
cp $SRC/256x256.png $DEST/128x128@2x.png

# Generate macOS icon.icns
mkdir -p $DEST/icon.iconset
cp $SRC/16x16.png $DEST/icon.iconset/icon_16x16.png
cp $SRC/32x32.png $DEST/icon.iconset/icon_16x16@2x.png
cp $SRC/32x32.png $DEST/icon.iconset/icon_32x32.png
cp $SRC/64x64.png $DEST/icon.iconset/icon_32x32@2x.png
cp $SRC/128x128.png $DEST/icon.iconset/icon_128x128.png
cp $SRC/256x256.png $DEST/icon.iconset/icon_128x128@2x.png
cp $SRC/256x256.png $DEST/icon.iconset/icon_256x256.png
cp $SRC/512x512.png $DEST/icon.iconset/icon_256x256@2x.png
cp $SRC/512x512.png $DEST/icon.iconset/icon_512x512.png
cp $SRC/1024x1024.png $DEST/icon.iconset/icon_512x512@2x.png
iconutil -c icns $DEST/icon.iconset -o $DEST/icon.icns
rm -rf $DEST/icon.iconset

echo "âœ“ Generated icons in $DEST"
'''
