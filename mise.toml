[tools]
node = "22"
rust = "1.85"

[env]
_.path = ['./ui/node_modules/.bin']

# ============================================================================
# SETUP TASKS
# ============================================================================

[tasks.install]
description = "Install frontend dependencies"
dir = "ui"
run = "npm install"
sources = ['package.json', 'package-lock.json']
outputs = ['node_modules']

[tasks.install-tauri-cli]
description = "Install Tauri CLI"
run = "cargo install tauri-cli --version '^2.0'"

[tasks.setup]
description = "Complete development setup"
depends = ["install", "install-tauri-cli"]

# ============================================================================
# DEVELOPMENT TASKS
# ============================================================================

[tasks.dev]
description = "Start development mode (frontend + Tauri)"
depends = ["install"]
run = "cargo tauri dev"

[tasks.dev-frontend]
description = "Start frontend dev server only"
dir = "ui"
run = "npm run dev"

# ============================================================================
# BUILD TASKS
# ============================================================================

[tasks.build-frontend]
description = "Build frontend for production"
depends = ["install"]
dir = "ui"
run = "npm run build"
sources = ['src/**/*', 'index.html', 'vite.config.ts']
outputs = ['../dist']

[tasks.build]
description = "Build complete application"
depends = ["build-frontend"]
run = "cargo tauri build"

[tasks.build-debug]
description = "Build debug version (faster)"
depends = ["build-frontend"]
run = "cargo tauri build --debug"

# ============================================================================
# UTILITY TASKS
# ============================================================================

[tasks.clean]
description = "Clean all build artifacts"
run = '''
#!/usr/bin/env bash
echo "Cleaning build artifacts..."
rm -rf dist 2>/dev/null || true
rm -rf ui/node_modules 2>/dev/null || true
rm -rf src-tauri/target 2>/dev/null || true
echo "Clean completed!"
'''

[tasks.launch-mac]
description = "Run the existing app"
run = "open ./src-tauri/target/debug/bundle/macos/Mocha.app"

[tasks.version]
description = "Show or set version (usage: mise run version [0.2.0])"
run = "node scripts/set-version.js"

[tasks.release]
description = "Create a release tag and push to trigger CI builds (macOS, Windows)"
run = '''
#!/usr/bin/env bash
set -e

# Get current version from tauri.conf.json
CURRENT_VERSION=$(grep -o '"version": "[^"]*"' src-tauri/tauri.conf.json | head -1 | cut -d'"' -f4)

echo "============================================"
echo "  Release Helper"
echo "============================================"
echo ""
echo "Current version: $CURRENT_VERSION"
echo ""

# Check if version looks valid
if [[ ! "$CURRENT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
  echo "Invalid version format: $CURRENT_VERSION"
  echo ""
  echo "To release a new version:"
  echo "  1. Update version: mise run version <new-version>"
  echo "  2. Commit changes: git add -A && git commit -m \"Bump version to <new-version>\""
  echo "  3. Run release:    mise run release"
  echo ""
  exit 1
fi

# Check for uncommitted changes
if ! git diff-index --quiet HEAD -- 2>/dev/null; then
  echo "You have uncommitted changes!"
  echo ""
  git status --short
  echo ""
  read -p "Commit all changes before release? (y/n) " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    git add -A
    git commit -m "Prepare release v$CURRENT_VERSION"
  else
    echo "Please commit your changes first."
    exit 1
  fi
fi

echo "This will:"
echo "  1. Create tag: v$CURRENT_VERSION"
echo "  2. Push tag to origin"
echo "  3. Trigger GitHub Actions to build for:"
echo "     - macOS (universal: Intel + Apple Silicon)"
echo "     - Windows (x64)"
echo ""

read -p "Proceed with release v$CURRENT_VERSION? (y/n) " -n 1 -r
echo

if [[ $REPLY =~ ^[Yy]$ ]]; then
  echo ""
  echo "Creating tag v$CURRENT_VERSION..."
  git tag "v$CURRENT_VERSION"

  echo "Pushing tag to origin..."
  git push origin "v$CURRENT_VERSION"

  # Get repo URL for actions link
  REPO_URL=$(git remote get-url origin | sed 's/\.git$//' | sed 's/git@github.com:/https:\/\/github.com\//')

  echo ""
  echo "Release v$CURRENT_VERSION initiated!"
  echo ""
  echo "Next steps:"
  echo "  1. Watch build progress: $REPO_URL/actions"
  echo "  2. Once complete, review draft release"
  echo "  3. Publish the release"
  echo ""
else
  echo "Release cancelled."
fi
'''

[tasks.icons]
description = "Generate app icons from source PNGs in _tmp/icon/"
run = '''
#!/usr/bin/env bash
set -e
SRC=_tmp/icon
DEST=src-tauri/icons

mkdir -p $DEST

# Copy base PNGs for Tauri
cp $SRC/32x32.png $DEST/
cp $SRC/128x128.png $DEST/
cp $SRC/256x256.png $DEST/icon.png
cp $SRC/256x256.png $DEST/128x128@2x.png

# Generate macOS icon.icns
mkdir -p $DEST/icon.iconset
cp $SRC/16x16.png $DEST/icon.iconset/icon_16x16.png
cp $SRC/32x32.png $DEST/icon.iconset/icon_16x16@2x.png
cp $SRC/32x32.png $DEST/icon.iconset/icon_32x32.png
cp $SRC/64x64.png $DEST/icon.iconset/icon_32x32@2x.png
cp $SRC/128x128.png $DEST/icon.iconset/icon_128x128.png
cp $SRC/256x256.png $DEST/icon.iconset/icon_128x128@2x.png
cp $SRC/256x256.png $DEST/icon.iconset/icon_256x256.png
cp $SRC/512x512.png $DEST/icon.iconset/icon_256x256@2x.png
cp $SRC/512x512.png $DEST/icon.iconset/icon_512x512.png
cp $SRC/1024x1024.png $DEST/icon.iconset/icon_512x512@2x.png
iconutil -c icns $DEST/icon.iconset -o $DEST/icon.icns
rm -rf $DEST/icon.iconset

# Generate Windows icon.ico (requires ImageMagick)
if command -v magick &> /dev/null; then
  magick $DEST/icon.png -define icon:auto-resize=256,128,64,48,32,16 $DEST/icon.ico
  echo "✓ Generated icon.ico"
else
  echo "⚠ ImageMagick not found, skipping icon.ico (install with: brew install imagemagick)"
fi

echo "✓ Generated icons in $DEST"
'''
